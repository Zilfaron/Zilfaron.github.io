window.addEventListener("load",()=>{let a={logState:{enable:!1,once:!1,interval:4500},darkTheme:{bgColor:"#212121",gridColor:"#EDEDED"},lightTheme:{bgColor:"#ffffff",gridColor:"#1B1B1B"},canv:{elemSelector:".game-area",width:450,height:900},fastFall:{pressed:!1,speed:60},gridCellSize:50,gridColor:"#000000",gridViewEnabled:!0,mainColor:"#ff0000",matrix:[],currentFigure:{templateMatrix:null,templateIndex:null,subTemplateIndex:null,width:null,height:null,row:0,col:0},speed:1e3,scores:0,paused:!1,set _paused(a){this.paused=a,!0===a?document.title="*PAUSED* Tetris":!1==a&&(document.title="Tetris")},figureTemplates:window.source.templates,figureColors:["#00C4DE","#4D00F0","#F08200","#CDF000","#00CA00","#A322F3"]};a.canv.height=window.innerHeight-10,a.canv.width=a.canv.height/2,a.gridCellSize=~~(a.canv.width/10),(0!=a.canv.width%a.gridCellSize||0!=a.canv.height%a.gridCellSize)&&(a.canv.width-=a.canv.width%a.gridCellSize,a.canv.height-=a.canv.height%a.gridCellSize),a.gridRows=a.canv.height/a.gridCellSize,a.gridCols=a.canv.width/a.gridCellSize;let b=document.querySelector(".page-wrapper"),c=document.querySelector(a.canv.elemSelector),d=c.getContext("2d");[c.width,c.height]=[a.canv.width,a.canv.height],c.style.display="block";let e=document.querySelector(".grid-view-checkbox");e.addEventListener("change",b=>{a.gridViewEnabled=b.target.checked}),window.addEventListener("keydown",b=>{80===b.keyCode&&(a._paused=!a.paused)}),window.addEventListener("blur",()=>{a._paused=!0});let f=document.querySelector(".dark-theme-checkbox");f.addEventListener("change",d=>{d.target.checked?(b.style.backgroundColor=a.darkTheme.bgColor,a.gridColor=a.darkTheme.gridColor,document.body.style.color=a.darkTheme.gridColor,c.style.borderColor=a.darkTheme.gridColor):(b.style.backgroundColor=a.lightTheme.bgColor,a.gridColor=a.lightTheme.gridColor,document.body.style.color="",c.style.borderColor=a.lightTheme.gridColor)});let g=document.querySelector(".music-btn"),h=document.querySelector(".music-volume-control"),i=new Audio;i.src="Tetris.ogg",i.paused=!0,i.loop=!0,i.volume=h.value,g.addEventListener("click",()=>{i.paused?i.play():i.pause()}),h.addEventListener("input",a=>{i.volume=a.target.value});let j=()=>{a.matrix=Array(a.gridRows).fill(null).map(()=>Array(a.gridCols).fill(null).map(()=>0))},k=()=>{let b=~~(Math.random()*a.figureTemplates.length);for(;b===a.currentFigure.templateIndex;)b=~~(Math.random()*a.figureTemplates.length);a.currentFigure.templateIndex=b,a.currentFigure.templateMatrix=a.figureTemplates[b][0].slice(),a.currentFigure.subTemplateIndex=0,a.currentFigure.width=a.currentFigure.templateMatrix[0].length,a.currentFigure.height=a.currentFigure.templateMatrix.length},l=(b,c)=>{let d=b===void 0?a.currentFigure.row:b,e=c===void 0?a.currentFigure.col:c;a.currentFigure.templateMatrix.forEach((b,c)=>{b.forEach((b,f)=>{if(1===b){a.matrix[d+c][e+f]=0}})})},m=(b,c)=>{let d=b===void 0?a.currentFigure.row:b,e=c===void 0?a.currentFigure.col:c;a.currentFigure.templateMatrix.forEach((b,c)=>{b.forEach((b,f)=>{if(1===b){a.matrix[d+c][e+f]=a.figureColors[a.currentFigure.templateIndex]}})})},n=()=>{if(a.finished)return!1;let b=0;a.matrix.forEach((c,d)=>{c.every(a=>"string"==typeof a)&&(a.matrix.splice(d,1),s(),a.scores+=100,b+=1)}),1<b&&(a.scores+=100*b),document.querySelector(".scores").textContent=a.scores,k();let c=~~(Math.random()*(a.gridCols-a.currentFigure.width+1));[a.currentFigure.row,a.currentFigure.col]=[0,c],m(),Object.values(q()).some(a=>a)&&y()},o=()=>{let b=a.currentFigure.subTemplateIndex,c=a.currentFigure.templateIndex;a.currentFigure.templateMatrix=a.figureTemplates[c][b].slice(),a.currentFigure.width=a.currentFigure.templateMatrix[0].length,a.currentFigure.height=a.currentFigure.templateMatrix.length,a.currentFigure.height>a.currentFigure.width?(a.currentFigure.row-=1,a.currentFigure.col+=1,0>a.currentFigure.row&&(a.currentFigure.row=0)):a.currentFigure.height<a.currentFigure.width&&(a.currentFigure.row+=1,a.currentFigure.col-=1)},p=()=>{let b=a.figureTemplates[a.currentFigure.templateIndex].length;1<b&&(a.currentFigure.subTemplateIndex>=b-1?a.currentFigure.subTemplateIndex=0:a.currentFigure.subTemplateIndex+=1,o())},q=()=>{let b=a.currentFigure.row,d=a.currentFigure.col,c=a.currentFigure.templateMatrix.some((c,e)=>"string"==typeof a.matrix[b+e][d+c.indexOf(1)-1]),e=a.currentFigure.templateMatrix.some((c,e)=>"string"==typeof a.matrix[b+e][d+c.lastIndexOf(1)+1]),f=!1,g=Array(a.currentFigure.width).fill(null).map(()=>0);return a.currentFigure.templateMatrix.forEach((a,b)=>{a.forEach((a,c)=>{1===a&&(g[c]=b)})}),g.forEach((c,e)=>{if(!f){let g=void 0!==a.matrix[b+c+1];return g?void("string"==typeof a.matrix[b+c+1][d+e]&&(f=!0)):void(f=!0)}}),{onLeft:c,onRight:e,below:f}},r=()=>{let b=a.gridCellSize;a.matrix.forEach((a,c)=>{a.forEach((a,e)=>{0!==a&&"string"==typeof a&&"#"===a.charAt(0)&&(d.beginPath(),d.fillStyle=a,d.fillRect(e*b,c*b,b,b))})})},s=()=>{let b=Array(a.gridCols).fill(null).map(()=>0);a.matrix.unshift(b)},t=()=>{let b=a.gridCellSize;for(let c=0;c<a.gridRows;c++)for(let e=0;e<a.gridCols;e++)d.beginPath(),d.lineWidth=.5,d.strokeStyle=a.gridColor,d.strokeRect(e*b,c*b,b,b),d.closePath()},u=()=>{d.clearRect(0,0,a.canv.width,a.canv.height),r(),a.gridViewEnabled&&t(),requestAnimationFrame(u)},v=()=>{setInterval(()=>a.fastFall.pressed&&!a.paused&&(q().below?(n(),!0):void(l(),a.currentFigure.row+=1,m())),a.fastFall.speed);window.addEventListener("keydown",b=>{40!==b.keyCode||a.paused||(a.fastFall.pressed=!0)}),window.addEventListener("keyup",b=>{40===b.keyCode&&(a.fastFall.pressed=!1)});let b=[37,39,82];window.addEventListener("keydown",c=>{if(!b.includes(c.keyCode)||a.paused)return!1;let d=q();switch(l(),c.keyCode){case 37:if(d.onLeft)return m(),n(),!0;a.currentFigure.col-=1;break;case 39:if(d.onRight)return m(),n(),!0;a.currentFigure.col+=1;break;case 82:p();break;default:return!1;}0>=a.currentFigure.col?a.currentFigure.col=0:a.currentFigure.col>=a.gridCols-a.currentFigure.width&&(a.currentFigure.col=a.gridCols-a.currentFigure.width),m()})},w=()=>{a.fastFall.pressed||a.paused||(q().below?n():(l(),a.currentFigure.row+=1,m()))},x=null,y=()=>{console.log(`You lose, scores: ${a.scores}`),a.scores=0,j(),n(),clearInterval(x),x=setInterval(w,a.speed)};(()=>{if(j(),u(),v(),n(),x=setInterval(w,a.speed),a.logState.enable){let b=setInterval(()=>{console.log(a.matrix),a.logState.once&&clearInterval(b)},a.logState.interval)}})()});